"use strict";

Object.defineProperty(exports, "__esModule", {
  value: true
});
exports.default = void 0;

var _path = _interopRequireDefault(require("path"));

var _dotenv = _interopRequireDefault(require("dotenv"));

var _fastify = _interopRequireDefault(require("fastify"));

var _fastifyStatic = _interopRequireDefault(require("fastify-static"));

var _fastifyErrorPage = _interopRequireDefault(require("fastify-error-page"));

var _fastifySensible = _interopRequireDefault(require("fastify-sensible"));

var _fastifyFormbody = _interopRequireDefault(require("fastify-formbody"));

var _qs = _interopRequireDefault(require("qs"));

var _fastifyReverseRoutes = require("fastify-reverse-routes");

var _fastifyMethodOverride = _interopRequireDefault(require("fastify-method-override"));

var _fastifyObjectionjs = _interopRequireDefault(require("fastify-objectionjs"));

var _fastifyPassport = _interopRequireDefault(require("fastify-passport"));

var _fastifySecureSession = _interopRequireDefault(require("fastify-secure-session"));

var _pug = _interopRequireDefault(require("pug"));

var _pointOfView = _interopRequireDefault(require("point-of-view"));

var _i18next = _interopRequireDefault(require("i18next"));

var _ru = _interopRequireDefault(require("./locales/ru.js"));

var _index = _interopRequireDefault(require("./routes/index.js"));

var _index2 = _interopRequireDefault(require("./helpers/index.js"));

var _knexfile = _interopRequireDefault(require("../knexfile.js"));

var _index3 = _interopRequireDefault(require("./models/index.js"));

var _FormStrategy = _interopRequireDefault(require("./lib/passportStrategies/FormStrategy.js"));

function _interopRequireDefault(obj) { return obj && obj.__esModule ? obj : { default: obj }; }

_dotenv.default.config();

console.log(process.env.DATABASE_URL);
const mode = process.env.NODE_ENV || 'development';
const isProduction = mode === 'production';
const isDevelopment = mode === 'development';

const registerViewsPlugin = app => {
  const domain = isDevelopment ? 'http://0.0.0.0:5000' : '';
  const helpers = (0, _index2.default)(app);
  app.register(_pointOfView.default, {
    engine: {
      pug: _pug.default
    },
    includeViewExtension: true,
    templates: _path.default.join(__dirname, '..', 'server', 'views'),
    defaultContext: { ...helpers,

      assetPath(filename) {
        return `${domain}/assets/${filename}`;
      }

    }
  }); // необходимо именно добавлять декоратор,а не свойство, иначе не заработает flash в пуге

  app.decorateReply('render', function render(viewPath, locals) {
    this.view(viewPath, { ...locals,
      reply: this
    });
  });
};

const registerStaticPlugin = app => {
  const pathPublic = isProduction ? _path.default.join(__dirname, '..', 'public') : _path.default.join(__dirname, '..', 'dist', 'public');
  app.register(_fastifyStatic.default, {
    root: pathPublic,
    prefix: '/assets/',
    list: true
  });
};

const setupLocalization = () => {
  _i18next.default.init({
    lng: 'ru',
    fallbackLng: 'en',
    // debug: isDevelopment,
    resources: {
      ru: _ru.default
    }
  });
};

const addHooks = app => {
  // this is for point of view. isAuthenticated() is now available in pug
  app.addHook('preHandler', async (req, reply) => {
    reply.locals = {
      isAuthenticated: () => req.isAuthenticated()
    };
  });
};

const registerMainPlugins = app => {
  app.register(_fastifySensible.default);
  app.register(_fastifyErrorPage.default);
  app.register(_fastifyReverseRoutes.plugin); // app.register(fastifyFormBody);
  // парсер ниже нужен для вложенных объектов

  app.register(_fastifyFormbody.default, {
    parser: _qs.default.parse
  });
  app.register(_fastifySecureSession.default, {
    secret: process.env.SESSION_KEY,
    cookie: {
      path: '/'
    }
  });

  _fastifyPassport.default.registerUserDeserializer(user => app.objection.models.user.query().findById(user.id));

  _fastifyPassport.default.registerUserSerializer(user => Promise.resolve(user));

  _fastifyPassport.default.use(new _FormStrategy.default('form', app));

  app.register(_fastifyPassport.default.initialize());
  app.register(_fastifyPassport.default.secureSession()); // this one is for 'app.fp' ad then method authenticate() from strategy:

  app.decorate('fp', _fastifyPassport.default); // this one is for { preValidation: app.authenticate }:

  app.decorate('authenticate', (...args) => _fastifyPassport.default.authenticate('form', {
    failureRedirect: app.reverse('root'),
    failureFlash: _i18next.default.t('flash.authError')
  })(...args));
  app.register(_fastifyMethodOverride.default);
  app.register(_fastifyObjectionjs.default, {
    knexConfig: _knexfile.default[mode],
    models: _index3.default
  });
};

var _default = () => {
  const app = (0, _fastify.default)({
    // logger: {
    //   prettyPrint: isDevelopment,
    // },
    logger: true
  });
  registerMainPlugins(app);
  setupLocalization();
  registerViewsPlugin(app);
  registerStaticPlugin(app);
  (0, _index.default)(app);
  addHooks(app);
  return app;
};

exports.default = _default;
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uLy4uL3NlcnZlci9pbmRleC5qcyJdLCJuYW1lcyI6WyJkb3RlbnYiLCJjb25maWciLCJjb25zb2xlIiwibG9nIiwicHJvY2VzcyIsImVudiIsIkRBVEFCQVNFX1VSTCIsIm1vZGUiLCJOT0RFX0VOViIsImlzUHJvZHVjdGlvbiIsImlzRGV2ZWxvcG1lbnQiLCJyZWdpc3RlclZpZXdzUGx1Z2luIiwiYXBwIiwiZG9tYWluIiwiaGVscGVycyIsInJlZ2lzdGVyIiwicG9pbnRPZlZpZXciLCJlbmdpbmUiLCJwdWciLCJQdWciLCJpbmNsdWRlVmlld0V4dGVuc2lvbiIsInRlbXBsYXRlcyIsInBhdGgiLCJqb2luIiwiX19kaXJuYW1lIiwiZGVmYXVsdENvbnRleHQiLCJhc3NldFBhdGgiLCJmaWxlbmFtZSIsImRlY29yYXRlUmVwbHkiLCJyZW5kZXIiLCJ2aWV3UGF0aCIsImxvY2FscyIsInZpZXciLCJyZXBseSIsInJlZ2lzdGVyU3RhdGljUGx1Z2luIiwicGF0aFB1YmxpYyIsImZhc3RpZnlTdGF0aWMiLCJyb290IiwicHJlZml4IiwibGlzdCIsInNldHVwTG9jYWxpemF0aW9uIiwiaTE4bmV4dCIsImluaXQiLCJsbmciLCJmYWxsYmFja0xuZyIsInJlc291cmNlcyIsInJ1IiwiYWRkSG9va3MiLCJhZGRIb29rIiwicmVxIiwiaXNBdXRoZW50aWNhdGVkIiwicmVnaXN0ZXJNYWluUGx1Z2lucyIsImZhc3RpZnlTZW5zaWJsZSIsImZhc3RpZnlFcnJvclBhZ2UiLCJmYXN0aWZ5UmV2ZXJzZVJvdXRlcyIsImZhc3RpZnlGb3JtQm9keSIsInBhcnNlciIsInFzIiwicGFyc2UiLCJmYXN0aWZ5U2VjdXJlU2Vzc2lvbiIsInNlY3JldCIsIlNFU1NJT05fS0VZIiwiY29va2llIiwiZmFzdGlmeVBhc3Nwb3J0IiwicmVnaXN0ZXJVc2VyRGVzZXJpYWxpemVyIiwidXNlciIsIm9iamVjdGlvbiIsIm1vZGVscyIsInF1ZXJ5IiwiZmluZEJ5SWQiLCJpZCIsInJlZ2lzdGVyVXNlclNlcmlhbGl6ZXIiLCJQcm9taXNlIiwicmVzb2x2ZSIsInVzZSIsIkZvcm1TdHJhdGVneSIsImluaXRpYWxpemUiLCJzZWN1cmVTZXNzaW9uIiwiZGVjb3JhdGUiLCJhcmdzIiwiYXV0aGVudGljYXRlIiwiZmFpbHVyZVJlZGlyZWN0IiwicmV2ZXJzZSIsImZhaWx1cmVGbGFzaCIsInQiLCJmYXN0aWZ5TWV0aG9kT3ZlcnJpZGUiLCJmYXN0aWZ5T2JqZWN0aW9uSlMiLCJrbmV4Q29uZmlnIiwibG9nZ2VyIl0sIm1hcHBpbmdzIjoiOzs7Ozs7O0FBQUE7O0FBQ0E7O0FBRUE7O0FBQ0E7O0FBQ0E7O0FBQ0E7O0FBQ0E7O0FBQ0E7O0FBQ0E7O0FBQ0E7O0FBQ0E7O0FBQ0E7O0FBQ0E7O0FBRUE7O0FBQ0E7O0FBQ0E7O0FBQ0E7O0FBRUE7O0FBQ0E7O0FBQ0E7O0FBQ0E7O0FBQ0E7Ozs7QUFFQUEsZ0JBQU9DLE1BQVA7O0FBQ0FDLE9BQU8sQ0FBQ0MsR0FBUixDQUFZQyxPQUFPLENBQUNDLEdBQVIsQ0FBWUMsWUFBeEI7QUFDQSxNQUFNQyxJQUFJLEdBQUdILE9BQU8sQ0FBQ0MsR0FBUixDQUFZRyxRQUFaLElBQXdCLGFBQXJDO0FBQ0EsTUFBTUMsWUFBWSxHQUFHRixJQUFJLEtBQUssWUFBOUI7QUFDQSxNQUFNRyxhQUFhLEdBQUdILElBQUksS0FBSyxhQUEvQjs7QUFFQSxNQUFNSSxtQkFBbUIsR0FBSUMsR0FBRCxJQUFTO0FBQ25DLFFBQU1DLE1BQU0sR0FBR0gsYUFBYSxHQUFHLHFCQUFILEdBQTJCLEVBQXZEO0FBQ0EsUUFBTUksT0FBTyxHQUFHLHFCQUFXRixHQUFYLENBQWhCO0FBRUFBLEVBQUFBLEdBQUcsQ0FBQ0csUUFBSixDQUFhQyxvQkFBYixFQUEwQjtBQUN4QkMsSUFBQUEsTUFBTSxFQUFFO0FBQ05DLE1BQUFBLEdBQUcsRUFBRUM7QUFEQyxLQURnQjtBQUl4QkMsSUFBQUEsb0JBQW9CLEVBQUUsSUFKRTtBQUt4QkMsSUFBQUEsU0FBUyxFQUFFQyxjQUFLQyxJQUFMLENBQVVD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QXBCO0FBRUEsc0JBQVVBLEdBQVY7QUFDQW1DLEVBQUFBLFFBQVEsQ0FBQ25DLEdBQUQsQ0FBUjtBQUVBLFNBQU9BLEdBQVA7QUFDRCxDIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IHBhdGggZnJvbSAncGF0aCc7XG5pbXBvcnQgZG90ZW52IGZyb20gJ2RvdGVudic7XG5cbmltcG9ydCBmYXN0aWZ5IGZyb20gJ2Zhc3RpZnknO1xuaW1wb3J0IGZhc3RpZnlTdGF0aWMgZnJvbSAnZmFzdGlmeS1zdGF0aWMnO1xuaW1wb3J0IGZhc3RpZnlFcnJvclBhZ2UgZnJvbSAnZmFzdGlmeS1lcnJvci1wYWdlJztcbmltcG9ydCBmYXN0aWZ5U2Vuc2libGUgZnJvbSAnZmFzdGlmeS1zZW5zaWJsZSc7XG5pbXBvcnQgZmFzdGlmeUZvcm1Cb2R5IGZyb20gJ2Zhc3RpZnktZm9ybWJvZHknO1xuaW1wb3J0IHFzIGZyb20gJ3FzJztcbmltcG9ydCB7IHBsdWdpbiBhcyBmYXN0aWZ5UmV2ZXJzZVJvdXRlcyB9IGZyb20gJ2Zhc3RpZnktcmV2ZXJzZS1yb3V0ZXMnO1xuaW1wb3J0IGZhc3RpZnlNZXRob2RPdmVycmlkZSBmcm9tICdmYXN0aWZ5LW1ldGhvZC1vdmVycmlkZSc7XG5pbXBvcnQgZmFzdGlmeU9iamVjdGlvbkpTIGZyb20gJ2Zhc3RpZnktb2JqZWN0aW9uanMnO1xuaW1wb3J0IGZhc3RpZnlQYXNzcG9ydCBmcm9tICdmYXN0aWZ5LXBhc3Nwb3J0JztcbmltcG9ydCBmYXN0aWZ5U2VjdXJlU2Vzc2lvbiBmcm9tICdmYXN0aWZ5LXNlY3VyZS1zZXNzaW9uJztcblxuaW1wb3J0IFB1ZyBmcm9tICdwdWcnO1xuaW1wb3J0IHBvaW50T2ZWaWV3IGZyb20gJ3BvaW50LW9mLXZpZXcnO1xuaW1wb3J0IGkxOG5leHQgZnJvbSAnaTE4bmV4dCc7XG5pbXBvcnQgcnUgZnJvbSAnLi9sb2NhbGVzL3J1LmpzJztcblxuaW1wb3J0IGFkZFJvdXRlcyBmcm9tICcuL3JvdXRlcy9pbmRleC5qcyc7XG5pbXBvcnQgZ2V0SGVscGVycyBmcm9tICcuL2hlbHBlcnMvaW5kZXguanMnO1xuaW1wb3J0IGtuZXhDb25maWcgZnJvbSAnLi4va25leGZpbGUuanMnO1xuaW1wb3J0IG1vZGVscyBmcm9tICcuL21vZGVscy9pbmRleC5qcyc7XG5pbXBvcnQgRm9ybVN0cmF0ZWd5IGZyb20gJy4vbGliL3Bhc3Nwb3J0U3RyYXRlZ2llcy9Gb3JtU3RyYXRlZ3kuanMnO1xuXG5kb3RlbnYuY29uZmlnKCk7XG5jb25zb2xlLmxvZyhwcm9jZXNzLmVudi5EQVRBQkFTRV9VUkwpO1xuY29uc3QgbW9kZSA9IHByb2Nlc3MuZW52Lk5PREVfRU5WIHx8ICdkZXZlbG9wbWVudCc7XG5jb25zdCBpc1Byb2R1Y3Rpb24gPSBtb2RlID09PSAncHJvZHVjdGlvbic7XG5jb25zdCBpc0RldmVsb3BtZW50ID0gbW9kZSA9PT0gJ2RldmVsb3BtZW50JztcblxuY29uc3QgcmVnaXN0ZXJWaWV3c1BsdWdpbiA9IChhcHApID0+IHtcbiAgY29uc3QgZG9tYWluID0gaXNEZXZlbG9wbWVudCA/ICdodHRwOi8vMC4wLjAuMDo1MDAwJyA6ICcnO1xuICBjb25zdCBoZWxwZXJzID0gZ2V0SGVscGVycyhhcHApO1xuXG4gIGFwcC5yZWdpc3Rlcihwb2ludE9mVmlldywge1xuICAgIGVuZ2luZToge1xuICAgICAgcHVnOiBQdWcsXG4gICAgfSxcbiAgICBpbmNsdWRlVmlld0V4dGVuc2lvbjogdHJ1ZSxcbiAgICB0ZW1wbGF0ZXM6IHBhdGguam9pbihfX2Rpcm5hbWUsICcuLicsICdzZXJ2ZXInLCAndmlld3MnKSxcbiAgICBkZWZhdWx0Q29udGV4dDoge1xuICAgICAgLi4uaGVscGVycyxcbiAgICAgIGFzc2V0UGF0aChmaWxlbmFtZSkge1xuICAgICAgICByZXR1cm4gYCR7ZG9tYWlufS9hc3NldHMvJHtmaWxlbmFtZX1gO1xuICAgICAgfSxcbiAgICB9LFxuICB9KTtcblxuICAvLyDQvdC10L7QsdGF0L7QtNC40LzQviDQuNC80LXQvdC90L4g0LTQvtCx0LDQstC70Y/RgtGMINC00LXQutC+0YDQsNGC0L7RgCzQsCDQvdC1INGB0LLQvtC50YHRgtCy0L4sINC40L3QsNGH0LUg0L3QtSDQt9Cw0YDQsNCx0L7RgtCw0LXRgiBmbGFzaCDQsiDQv9GD0LPQtVxuICBhcHAuZGVjb3JhdGVSZXBseSgncmVuZGVyJywgZnVuY3Rpb24gcmVuZGVyKHZpZXdQYXRoLCBsb2NhbHMpIHtcbiAgICB0aGlzLnZpZXcodmlld1BhdGgsIHsgLi4ubG9jYWxzLCByZXBseTogdGhpcyB9KTtcbiAgfSk7XG59O1xuXG5jb25zdCByZWdpc3RlclN0YXRpY1BsdWdpbiA9IChhcHApID0+IHtcbiAgY29uc3QgcGF0aFB1YmxpYyA9IGlzUHJvZHVjdGlvblxuICAgID8gcGF0aC5qb2luKF9fZGlybmFtZSwgJy4uJywgJ3B1YmxpYycpXG4gICAgOiBwYXRoLmpvaW4oX19kaXJuYW1lLCAnLi4nLCAnZGlzdCcsICdwdWJsaWMnKTtcblxuICBhcHAucmVnaXN0ZXIoZmFzdGlmeVN0YXRpYywge1xuICAgIHJvb3Q6IHBhdGhQdWJsaWMsXG4gICAgcHJlZml4OiAnL2Fzc2V0cy8nLFxuICAgIGxpc3Q6IHRydWUsXG4gIH0pO1xufTtcblxuY29uc3Qgc2V0dXBMb2NhbGl6YXRpb24gPSAoKSA9PiB7XG4gIGkxOG5leHRcbiAgICAuaW5pdCh7XG4gICAgICBsbmc6ICdydScsXG4gICAgICBmYWxsYmFja0xuZzogJ2VuJyxcbiAgICAgIC8vIGRlYnVnOiBpc0RldmVsb3BtZW50LFxuICAgICAgcmVzb3VyY2VzOiB7XG4gICAgICAgIHJ1LFxuICAgICAgfSxcbiAgICB9KTtcbn07XG5cbmNvbnN0IGFkZEhvb2tzID0gKGFwcCkgPT4ge1xuICAvLyB0aGlzIGlzIGZvciBwb2ludCBvZiB2aWV3LiBpc0F1dGhlbnRpY2F0ZWQoKSBpcyBub3cgYXZhaWxhYmxlIGluIHB1Z1xuICBhcHAuYWRkSG9vaygncHJlSGFuZGxlcicsIGFzeW5jIChyZXEsIHJlcGx5KSA9PiB7XG4gICAgcmVwbHkubG9jYWxzID0ge1xuICAgICAgaXNBdXRoZW50aWNhdGVkOiAoKSA9PiByZXEuaXNBdXRoZW50aWNhdGVkKCksXG4gICAgfTtcbiAgfSk7XG59O1xuXG5jb25zdCByZWdpc3Rlck1haW5QbHVnaW5zID0gKGFwcCkgPT4ge1xuICBhcHAucmVnaXN0ZXIoZmFzdGlmeVNlbnNpYmxlKTtcbiAgYXBwLnJlZ2lzdGVyKGZhc3RpZnlFcnJvclBhZ2UpO1xuICBhcHAucmVnaXN0ZXIoZmFzdGlmeVJldmVyc2VSb3V0ZXMpO1xuICAvLyBhcHAucmVnaXN0ZXIoZmFzdGlmeUZvcm1Cb2R5KTtcbiAgLy8g0L/QsNGA0YHQtdGAINC90LjQttC1INC90YPQttC10L0g0LTQu9GPINCy0LvQvtC20LXQvdC90YvRhSDQvtCx0YrQtdC60YLQvtCyXG4gIGFwcC5yZWdpc3RlcihmYXN0aWZ5Rm9ybUJvZHksIHsgcGFyc2VyOiBxcy5wYXJzZSB9KTtcblxuICBhcHAucmVnaXN0ZXIoZmFzdGlmeVNlY3VyZVNlc3Npb24sIHtcbiAgICBzZWNyZXQ6IHByb2Nlc3MuZW52LlNFU1NJT05fS0VZLFxuICAgIGNvb2tpZToge1xuICAgICAgcGF0aDogJy8nLFxuICAgIH0sXG4gIH0pO1xuXG4gIGZhc3RpZnlQYXNzcG9ydC5yZWdpc3RlclVzZXJEZXNlcmlhbGl6ZXIoXG4gICAgKHVzZXIpID0+IGFwcC5vYmplY3Rpb24ubW9kZWxzLnVzZXIucXVlcnkoKS5maW5kQnlJZCh1c2VyLmlkKSxcbiAgKTtcbiAgZmFzdGlmeVBhc3Nwb3J0LnJlZ2lzdGVyVXNlclNlcmlhbGl6ZXIoKHVzZXIpID0+IFByb21pc2UucmVzb2x2ZSh1c2VyKSk7XG4gIGZhc3RpZnlQYXNzcG9ydC51c2UobmV3IEZvcm1TdHJhdGVneSgnZm9ybScsIGFwcCkpO1xuICBhcHAucmVnaXN0ZXIoZmFzdGlmeVBhc3Nwb3J0LmluaXRpYWxpemUoKSk7XG4gIGFwcC5yZWdpc3RlcihmYXN0aWZ5UGFzc3BvcnQuc2VjdXJlU2Vzc2lvbigpKTtcbiAgLy8gdGhpcyBvbmUgaXMgZm9yICdhcHAuZnAnIGFkIHRoZW4gbWV0aG9kIGF1dGhlbnRpY2F0ZSgpIGZyb20gc3RyYXRlZ3k6XG4gIGFwcC5kZWNvcmF0ZSgnZnAnLCBmYXN0aWZ5UGFzc3BvcnQpO1xuICAvLyB0aGlzIG9uZSBpcyBmb3IgeyBwcmVWYWxpZGF0aW9uOiBhcHAuYXV0aGVudGljYXRlIH06XG4gIGFwcC5kZWNvcmF0ZSgnYXV0aGVudGljYXRlJywgKC4uLmFyZ3MpID0+IGZhc3RpZnlQYXNzcG9ydC5hdXRoZW50aWNhdGUoXG4gICAgJ2Zvcm0nLFxuICAgIHtcbiAgICAgIGZhaWx1cmVSZWRpcmVjdDogYXBwLnJldmVyc2UoJ3Jvb3QnKSxcbiAgICAgIGZhaWx1cmVGbGFzaDogaTE4bmV4dC50KCdmbGFzaC5hdXRoRXJyb3InKSxcbiAgICB9LFxuICApKC4uLmFyZ3MpKTtcblxuICBhcHAucmVnaXN0ZXIoZmFzdGlmeU1ldGhvZE92ZXJyaWRlKTtcbiAgYXBwLnJlZ2lzdGVyKGZhc3RpZnlPYmplY3Rpb25KUywge1xuICAgIGtuZXhDb25maWc6IGtuZXhDb25maWdbbW9kZV0sXG4gICAgbW9kZWxzLFxuICB9KTtcbn07XG5cbmV4cG9ydCBkZWZhdWx0ICgpID0+IHtcbiAgY29uc3QgYXBwID0gZmFzdGlmeSh7XG4gICAgLy8gbG9nZ2VyOiB7XG4gICAgLy8gICBwcmV0dHlQcmludDogaXNEZXZlbG9wbWVudCxcbiAgICAvLyB9LFxuICAgIGxvZ2dlcjogdHJ1ZSxcbiAgfSk7XG5cbiAgcmVnaXN0ZXJNYWluUGx1Z2lucyhhcHApO1xuXG4gIHNldHVwTG9jYWxpemF0aW9uKCk7XG4gIHJlZ2lzdGVyVmlld3NQbHVnaW4oYXBwKTtcbiAgcmVnaXN0ZXJTdGF0aWNQbHVnaW4oYXBwKTtcblxuICBhZGRSb3V0ZXMoYXBwKTtcbiAgYWRkSG9va3MoYXBwKTtcblxuICByZXR1cm4gYXBwO1xufTtcbiJdfQ==